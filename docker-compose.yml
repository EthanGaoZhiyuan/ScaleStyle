version: '3.8'

services:
  # ==========================================
  # 1. Java Gateway Service (Spring Boot)
  # ==========================================
  gateway-service:
    container_name: scalestyle-gateway
    build: 
      context: ./gateway-service
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      # Service Discovery: Use the service name "inference-service" directly within the Docker network
      - GRPC_SERVER_HOST=inference-service
      - GRPC_SERVER_PORT=50051
      - METADATA_PATH=/app/data/product_metadata.json
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      - ./data-pipeline/data/processed:/app/data
    depends_on:
      inference-service:
        condition: service_started
    networks:
      - scalestyle-net

  # ==========================================
  # 2. Python Inference Service (gRPC + Ray Logic)
  # ==========================================
  inference-service:
    container_name: scalestyle-inference
    build: 
      context: ./inference-service
      dockerfile: Dockerfile
    ports:
      - "50051:50051"
    environment:
      - PORT=50051
      # Internal path for reading data inside the container
      - DATA_PATH=/app/data/top_items_parquet
      # (Optional) Environment variables reserved for future MinIO connection
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin
      - AWS_ENDPOINT_URL=http://minio:9000
      - MILVUS_HOST=milvus
      - MILVUS_PORT=19530
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      # ðŸš€ Key Point: Mount the host-generated Parquet data into the container
      # Format: Host Path : Container Path
      - ./data-pipeline/data/processed/top_items_parquet:/app/data/top_items_parquet
    networks:
      - scalestyle-net

  # ==========================================
  # 3. MinIO (S3 Compatible Storage - Object Store)
  # ==========================================
  minio:
    container_name: scalestyle-minio
    image: minio/minio:RELEASE.2024-01-13T07-53-03Z
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000" # API Port
      - "9001:9001" # Console UI Port
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/data
    networks:
      - scalestyle-net
  # ==========================================
  # 4. Etcd (Required by Milvus)
  # ==========================================
  etcd:
    container_name: scalestyle-etcd
    image: quay.io/coreos/etcd:v3.5.5
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=8589934592
      - ETCD_SNAPSHOT_COUNT=50000
    volumes:
      - etcd_data:/etcd-data
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    networks:
      - scalestyle-net
  # ==========================================
  # 5. Milvus (Vector Database)
  # ==========================================
  milvus:
    container_name: scalestyle-milvus
    image: milvusdb/milvus:v2.3.3
    command: milvus run standalone
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
      MINIO_ACCESS_KEY_ID: minioadmin
      MINIO_SECRET_ACCESS_KEY: minioadmin
    volumes:
      - milvus_data:/var/lib/milvus
    ports:
      - "19530:19530" # gRPC Port
      - "9091:9091"   # HTTP Port
    depends_on:
      - etcd
      - minio
    networks:
      - scalestyle-net
  # ==========================================
  # 6. Attu (Milvus GUI)
  # ==========================================
  attu:
    container_name: scalestyle-attu
    image: zilliz/attu:latest 
    environment:
      MILVUS_URL: milvus:19530
    ports:
      - "8088:3000"
    depends_on:
      - milvus
    networks:
      - scalestyle-net
  # ==========================================
  # 7. Redis (In-Memory Data Store)
  # ==========================================
  redis:
    container_name: scalestyle-redis
    image: redis:7.0-alpine
    ports:
      - "6379:6379"
    networks:
      - scalestyle-net

# Define volumes (Persist MinIO data)
volumes:
  minio_data:
  etcd_data:
  milvus_data:
  redis_data:

# Define networks (Enable communication between containers)
networks:
  scalestyle-net:
    driver: bridge