version: '3.8'

services:
  # ==========================================
  # 1. Java Gateway Service (Spring Boot)
  # ==========================================
  gateway-service:
    container_name: scalestyle-gateway
    build:
      context: ./gateway-service
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - INFERENCE_BASE_URL=http://inference-service:8000
      - METADATA_PATH=/app/data/product_metadata.json
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      - ./data-pipeline/data/processed:/app/data
    depends_on:
      inference-service:
        condition: service_healthy
    networks:
      - scalestyle-net

  # ==========================================
  # 2. Python Inference Service (gRPC + Ray Logic)
  # ==========================================
  inference-service:
    container_name: scalestyle-inference
    build:
      context: ./inference-service
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - MILVUS_HOST=milvus
      - MILVUS_PORT=19530
      - MILVUS_COLLECTION=scale_style_bge_v2
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # HF cache in container
      - HF_HOME=/cache/huggingface
      - TRANSFORMERS_CACHE=/cache/huggingface/hub
      # ----- Embedding tuning -----
      - EMBEDDING_MODEL=BAAI/bge-large-en-v1.5
      - EMBEDDING_MAX_LEN=512
      - EMBEDDING_NUM_GPUS=0

      # ----- Popularity -----
      - POPULARITY_KEY=global:popular

      # ----- Reranker (unified RERANKER_* prefix for consistency) -----
      - RECALL_K=100
      - RETRIEVAL_TIMEOUT_MS=800
      - EMBEDDING_TIMEOUT_MS=1200
      - RERANKER_ENABLED=1
      - RERANKER_MODEL=BAAI/bge-reranker-base
      - RERANKER_DEVICE=cpu
      - RERANKER_BATCH_SIZE=32
      - RERANKER_MAX_DOCS=100
      - RERANKER_MODE=cross-encoder
      - RERANKER_TIMEOUT_MS=1200
      - RERANKER_WARMUP=1
      - RAY_SERVE_RUN_SYNC_IN_THREADPOOL=1
      - HF_HUB_DISABLE_TELEMETRY=1
      - TOKENIZERS_PARALLELISM=false
    volumes:
      - ./data-pipeline/data/processed/top_items_parquet:/app/data/top_items_parquet
      - hf_cache:/cache/huggingface
    depends_on:
      milvus:
        condition: service_started
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/readyz').read()"]
      interval: 10s
      timeout: 3s
      retries: 30
    networks:
      - scalestyle-net

  # ==========================================
  # 3. MinIO (S3 Compatible Storage - Object Store)
  # ==========================================
  minio:
    container_name: scalestyle-minio
    image: minio/minio:RELEASE.2024-01-13T07-53-03Z
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000" # API Port
      - "9001:9001" # Console UI Port
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/data
    networks:
      - scalestyle-net
  # ==========================================
  # 4. Etcd (Required by Milvus)
  # ==========================================
  etcd:
    container_name: scalestyle-etcd
    image: quay.io/coreos/etcd:v3.5.5
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=8589934592
      - ETCD_SNAPSHOT_COUNT=50000
    volumes:
      - etcd_data:/etcd-data
    command: >
      etcd
      -advertise-client-urls=http://etcd:2379
      -listen-client-urls=http://0.0.0.0:2379
      --data-dir /etcd
      --auto-compaction-mode=revision
      --auto-compaction-retention=1000
      --quota-backend-bytes=8589934592
      --snapshot-count=50000
    networks:
      - scalestyle-net
  # ==========================================
  # 5. Milvus (Vector Database)
  # ==========================================
  milvus:
    container_name: scalestyle-milvus
    image: milvusdb/milvus:v2.3.3
    command: milvus run standalone
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
      MINIO_ACCESS_KEY_ID: minioadmin
      MINIO_SECRET_ACCESS_KEY: minioadmin
    volumes:
      - milvus_data:/var/lib/milvus
    ports:
      - "19530:19530" # gRPC Port
      - "9091:9091"   # HTTP Port
    depends_on:
      - etcd
      - minio
    networks:
      - scalestyle-net
  # ==========================================
  # 6. Attu (Milvus GUI)
  # ==========================================
  attu:
    container_name: scalestyle-attu
    image: zilliz/attu:latest 
    environment:
      MILVUS_URL: milvus:19530
    ports:
      - "8088:3000"
    depends_on:
      - milvus
    networks:
      - scalestyle-net
  # ==========================================
  # 7. Redis (In-Memory Data Store)
  # ==========================================
  redis:
    container_name: scalestyle-redis
    image: redis:7.0-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30
    networks:
      - scalestyle-net

# Define volumes (Persist MinIO data)
volumes:
  minio_data:
  etcd_data:
  milvus_data:
  redis_data:
  hf_cache:

# Define networks (Enable communication between containers)
networks:
  scalestyle-net:
    driver: bridge