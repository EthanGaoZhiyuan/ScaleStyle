---
# Full Data Initialization Job: Load ALL data into Redis AND Milvus
# This variant enables complete vector search demo (not just fallback)
# Use this for production or full-featured demos
#
# To use this instead of fast init:
#   kubectl delete job data-init -n scalestyle  # Remove fast version
#   kubectl apply -f infrastructure/k8s/60-init-job.full.yaml
#
# Note: Takes 2-5 minutes to complete (vs 10-20s for fast init)

apiVersion: batch/v1
kind: Job
metadata:
  name: data-init-full
  namespace: scalestyle
  labels:
    app: scalestyle
    component: data-init-full
spec:
  # Keep job history for debugging
  ttlSecondsAfterFinished: 3600  # Clean up after 1 hour
  backoffLimit: 3  # Retry up to 3 times on failure
  
  template:
    metadata:
      labels:
        app: scalestyle
        component: data-init-full
    spec:
      restartPolicy: OnFailure
      
      # Init containers to wait for dependencies
      initContainers:
      - name: wait-for-redis
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "Waiting for Redis..."
          until nc -z redis 6379; do
            echo "Redis not ready, sleeping..."
            sleep 2
          done
          echo "Redis is ready!"
      
      - name: wait-for-milvus
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "Waiting for Milvus..."
          until nc -z milvus 19530; do
            echo "Milvus not ready, sleeping..."
            sleep 5
          done
          echo "Milvus is ready!"
      
      containers:
      - name: data-loader
        # Uses pre-built image with dependencies baked in
        # Build: docker build -t your-dockerhub-username/scalestyle-data-init:latest ./data-pipeline
        # Push: docker push your-dockerhub-username/scalestyle-data-init:latest
        image: your-dockerhub-username/scalestyle-data-init:latest
        imagePullPolicy: Always
        
        # Run bootstrap script from the image
        command: ["python", "-m", "src.bootstrap_data"]
        
        # Arguments for bootstrap script
        # Full initialization: load both Redis AND Milvus
        args:
        - "--no-verify"    # Skip verification for speed (optional)
        # NOTE: Removed --skip-milvus to enable full vector search
        
        # Environment variables from ConfigMap
        envFrom:
        - configMapRef:
            name: scalestyle-config
        
        # Resource limits (higher for full init with Milvus)
        resources:
          requests:
            cpu: "500m"
            memory: "1Gi"
          limits:
            cpu: "2"
            memory: "4Gi"
        
        # Volume mounts for data files
        volumeMounts:
        - name: data-volume
          mountPath: /app/data
          readOnly: true
      
      volumes:
      # Option 1: Use ConfigMap with embedded data (for small datasets)
      # - name: data-volume
      #   configMap:
      #     name: scalestyle-data
      
      # Option 2: Use PersistentVolumeClaim (for larger datasets)
      - name: data-volume
        persistentVolumeClaim:
          claimName: scalestyle-data-pvc
      
      # Option 3: Use emptyDir with init container to fetch from S3/GCS (recommended)
      # - name: data-volume
      #   emptyDir: {}

---
# Optional: PersistentVolumeClaim for data files
# Only needed if using Option 2 above
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: scalestyle-data-pvc
  namespace: scalestyle
spec:
  accessModes:
    - ReadOnlyMany
  resources:
    requests:
      storage: 10Gi
  # storageClassName: standard  # Adjust based on your cluster
