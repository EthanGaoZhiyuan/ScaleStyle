---
# ConfigMap: Single source of truth for all service configurations
# Migrated from docker-compose environment variables
apiVersion: v1
kind: ConfigMap
metadata:
  name: scalestyle-config
  namespace: scalestyle
  labels:
    app: scalestyle
    component: config
data:
  # ==========================================
  # Redis Configuration
  # ==========================================
  REDIS_HOST: "redis"
  REDIS_PORT: "6379"
  REDIS_DB: "0"
  REDIS_POOL_SIZE: "10"
  REDIS_SOCKET_TIMEOUT: "5"
  REDIS_SOCKET_CONNECT_TIMEOUT: "5"

  # ==========================================
  # Milvus Configuration
  # ==========================================
  MILVUS_HOST: "milvus"
  MILVUS_PORT: "19530"
  MILVUS_COLLECTION: "scale_style_bge_v2"
  MILVUS_BATCH_SIZE: "100"
  MILVUS_TIMEOUT: "30"

  # ==========================================
  # Generation Configuration (LLM)
  # ==========================================
  GENERATION_ENABLED: "1"
  GENERATION_MODE: "template"  # template or llm
  GENERATION_MODEL: "Qwen/Qwen2-1.5B-Instruct"
  GENERATION_DEVICE: "cpu"
  GENERATION_MAX_NEW_TOKENS: "48"
  GENERATION_TEMPERATURE: "0.2"
  GENERATION_TOP_P: "0.9"
  GENERATION_DO_SAMPLE: "0"
  GENERATION_WARMUP: "1"
  GENERATION_MAX_CONCURRENCY: "1"

  # ==========================================
  # Ray Serve Configuration
  # ==========================================
  RAY_SERVE_PORT: "8000"
  RAY_SERVE_HOST: "0.0.0.0"
  RAY_DASHBOARD_PORT: "8265"

  # ==========================================
  # Gateway Configuration
  # ==========================================
  GATEWAY_PORT: "8080"
  # P0-1 Fix: Must match Gateway's application.properties (INFERENCE_BASE_URL)
  INFERENCE_BASE_URL: "http://inference:8000"
  
  # Fix: HTTP client factory for Ray Serve compatibility
  SPRING_HTTP_CLIENT_FACTORY: "simple"
  
  # ==========================================
  # Observability Configuration
  # ==========================================
  OTEL_EXPORTER_OTLP_ENDPOINT: "http://jaeger-collector:4317"
  OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"
  OTEL_SERVICE_NAME: "scalestyle"
  OTEL_TRACES_EXPORTER: "otlp"
  OTEL_METRICS_EXPORTER: "none"
  OTEL_LOGS_EXPORTER: "none"
  
  # Prometheus metrics
  PROMETHEUS_PUSHGATEWAY: "http://prometheus-pushgateway:9091"

  # ==========================================
  # Performance Tuning
  # ==========================================
  JAVA_OPTS: "-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:+ExitOnOutOfMemoryError"
  
  # P1-1 Fix: Standardize HF cache path (matches inference Dockerfile)
  HF_HOME: "/cache/huggingface"
  TRANSFORMERS_CACHE: "/cache/huggingface/hub"
