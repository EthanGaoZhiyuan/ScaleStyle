# src/ray_serve/config.yaml

proxy_location: EveryNode

http_options:
  host: 0.0.0.0
  port: 8000

applications:
  - name: scale_style_app
    import_path: src.ray_serve.deployments.ingress:ingress_app
    route_prefix: /
    runtime_env:
      env_vars:
        # ========================================
        # Fix: Removed GENERATION_ENABLED from runtime_env
        # Let ConfigMap (single source of truth) control generation feature toggle
        # ConfigMap value: GENERATION_ENABLED="1" (default in K8s)
        # ========================================
        
        # Embedding configuration (Ray Serve specific)
        # Fix: Optimized for high concurrency with limited resources
        EMBEDDING_NUM_CPUS: "1"  # Production (äº‘): 2 CPU cores | Local (Docker Desktop): 1 CPU core
        EMBEDDING_QUERY_PREFIX: "Represent this sentence for searching relevant passages:"
        
        # Fix: Performance test mode - disable non-critical features
        # Set PERF_TEST_MODE="1" to disable CLIP/Generation for max throughput
        PERF_TEST_MODE: "0"  # 0=normal, 1=perf test (disable CLIP/Gen)
        
        # A/B testing configuration (Ray Serve specific)
        BASE_FLOW_MODE: "vector"  # Options: vector, popularity
        
        # Generation configuration (Optional feature, not in docker-compose)
        # Note: GENERATION_ENABLED controlled by ConfigMap/docker-compose, not here
        GENERATION_MODE: "template"  # Options: template (fast), llm (requires model)
        GENERATION_TIMEOUT_MS: "500"  # Week 3: Reduced from 600ms to 500ms
        GENERATION_FLOW: "smart"  # Options: smart (only SEARCH), all (always)
        GENERATION_MODEL: "Qwen/Qwen2-1.5B-Instruct"
        GENERATION_DEVICE: "auto"  # auto, cpu, cuda, mps
        GENERATION_MAX_NEW_TOKENS: "48"
        GENERATION_TEMPERATURE: "0.2"
        GENERATION_TOP_P: "0.9"
        GENERATION_DO_SAMPLE: "0"
        GENERATION_DTYPE: "float16"
        GENERATION_WARMUP: "1"
        
        # ========================================
        # NOTE: The following are controlled by docker-compose.yml:
        # - REDIS_HOST, REDIS_PORT, POPULARITY_KEY
        # - MILVUS_HOST, MILVUS_PORT, MILVUS_COLLECTION
        # - EMBEDDING_MODEL, EMBEDDING_MAX_LEN, EMBEDDING_NUM_GPUS, EMBEDDING_TIMEOUT_MS
        # - RECALL_K, RETRIEVAL_TIMEOUT_MS
        # - RERANKER_* (all reranker configs)
        # - HF_HOME, TRANSFORMERS_CACHE
        # - RAY_SERVE_RUN_SYNC_IN_THREADPOOL, TOKENIZERS_PARALLELISM
        # - OTEL_EXPORTER_OTLP_ENDPOINT, OTEL_SERVICE_NAME
        # ========================================
        # to ensure model cache persists across container restarts.
        HF_HUB_DISABLE_TELEMETRY: "1"